services:
  postgres:
    image: postgres:16-alpine
    container_name: namma-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${TZ}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 6
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - namma-net

  listmonk:
    image: listmonk/listmonk:latest
    container_name: namma-listmonk
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    command:
      - /bin/sh
      - -lc
      - /listmonk/start.sh
    environment:
      TZ: ${TZ}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      LISTMONK_ADMIN_USER: ${LISTMONK_ADMIN_USER}
      LISTMONK_ADMIN_PASSWORD: ${LISTMONK_ADMIN_PASSWORD}
      LISTMONK_FROM_EMAIL: ${LISTMONK_FROM_EMAIL}
      LISTMONK_PUBLIC_URL: ${LISTMONK_PUBLIC_URL}
    ports:
      - "9000:9000"
    volumes:
      - ./docker/listmonk/app.toml:/listmonk/config.toml:ro
      - ./docker/listmonk/start.sh:/listmonk/start.sh:ro
      - listmonk_uploads:/listmonk/uploads
    networks:
      - namma-net

  n8n:
    image: n8nio/n8n:latest
    container_name: namma-n8n
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      TZ: ${TZ}
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: ${N8N_PORT}
      N8N_PROTOCOL: ${N8N_PROTOCOL}
      WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE}
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_DIAGNOSTICS_ENABLED: "false"
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
    command:
      - /bin/sh
      - -lc
      - |
        /scripts/import_n8n_workflows.sh && n8n start
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/workflows:/workflows:ro
      - ./scripts/import_n8n_workflows.sh:/scripts/import_n8n_workflows.sh:ro
    networks:
      - namma-net

  opendkim:
    build:
      context: .
      dockerfile: docker/opendkim/Dockerfile
    container_name: namma-opendkim
    restart: unless-stopped
    environment:
      TZ: ${TZ}
    volumes:
      - opendkim_keys:/etc/opendkim/keys
      - ./docker/postfix/opendkim.conf:/etc/opendkim.conf:ro
      - ./docker/postfix/KeyTable.template:/etc/opendkim/KeyTable.template:ro
      - ./docker/postfix/SigningTable.template:/etc/opendkim/SigningTable.template:ro
      - ./docker/postfix/TrustedHosts:/etc/opendkim/TrustedHosts:ro
    networks:
      - namma-net

  postfix:
    build:
      context: .
      dockerfile: docker/postfix/Dockerfile
    container_name: namma-postfix
    restart: unless-stopped
    depends_on:
      - opendkim
    environment:
      TZ: ${TZ}
      DOMAIN: ${DOMAIN}
      MAIL_HOSTNAME: ${MAIL_HOSTNAME}
    ports:
      - "25:25"
    volumes:
      - postfix_spool:/var/spool/postfix
      - ./docker/postfix/main.cf.template:/etc/postfix/main.cf.template:ro
      - ./docker/postfix/master.cf.template:/etc/postfix/master.cf.template:ro
      - ./scripts:/opt/namma/scripts
    networks:
      - namma-net

  scrapling-api:
    build:
      context: .
      dockerfile: docker/scrapling/Dockerfile
    container_name: namma-scrapling-api
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      SCRAPLING_CONCURRENCY: ${SCRAPLING_CONCURRENCY}
      SCRAPLING_TIMEOUT_SECONDS: ${SCRAPLING_TIMEOUT_SECONDS}
      SCRAPLING_IMAGE_MAX_WIDTH: ${SCRAPLING_IMAGE_MAX_WIDTH}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
      CLOUDFLARE_R2_BUCKET: ${CLOUDFLARE_R2_BUCKET}
      CLOUDFLARE_R2_ENDPOINT: ${CLOUDFLARE_R2_ENDPOINT}
      R2_PUBLIC_BASE_URL: ${R2_PUBLIC_BASE_URL}
      NVIDIA_API_KEYS: ${NVIDIA_API_KEYS}
      NVIDIA_MODEL: ${NVIDIA_MODEL}
    ports:
      - "8000:8000"
    networks:
      - namma-net

networks:
  namma-net:
    driver: bridge

volumes:
  postgres_data:
  n8n_data:
  listmonk_uploads:
  postfix_spool:
  opendkim_keys:
